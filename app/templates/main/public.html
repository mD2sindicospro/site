{% extends "base.html" %}
{% from 'utils/translations.html' import translate_status, get_status_class %}

{% block title %}Lista de Atividades - Sistema de Gestão{% endblock %}

{% block content %}
<style>
    body {
        background: #f8f9fa;
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    .main-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .page-header {
        background: #2c3e50;
        color: white;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 25px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(44, 62, 80, 0.2);
    }
    
    .page-header h4 {
        margin: 0;
        font-weight: 500;
        font-size: 1.3rem;
    }
    
    .selector-section {
        background: white;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
    }
    
    .form-label {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 10px;
        text-align: center;
        display: block;
    }
    
    .form-select {
        border: 2px solid #e9ecef;
        border-radius: 6px;
        padding: 12px 15px;
        font-size: 1rem;
        transition: all 0.2s ease;
    }
    
    .form-select:focus {
        border-color: #2c3e50;
        box-shadow: 0 0 0 0.2rem rgba(44, 62, 80, 0.15);
    }
    
    .activities-section {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
    }
    
    .section-header {
        background: #f8f9fa;
        padding: 20px 25px;
        border-bottom: 1px solid #e9ecef;
        text-align: center;
    }
    
    .section-header h5 {
        margin: 0;
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .activities-list {
        padding: 20px 25px;
    }
    
    .activity-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 18px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    

    
    .activity-item:hover {
        background: #e3f2fd;
        border-color: #2c3e50;
        transform: translateY(-1px);
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    .activity-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
    }
    
    .activity-title {
        font-weight: 600;
        color: #2c3e50;
        font-size: 0.9rem;
        flex: 1;
        margin-right: 15px;
        line-height: 1.4;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .activity-status-container {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .view-icon {
        font-size: 0.8rem;
        color: #6c757d;
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }
    
    .activity-item:hover .view-icon {
        opacity: 1;
        color: #2c3e50;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 12px;
        font-weight: 600;
        letter-spacing: 0.3px;
    }
    
    .activity-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 25px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 15px;
        opacity: 0.4;
    }
    
    .empty-state p {
        margin: 0;
        font-size: 1rem;
    }
    
    .modal-content {
        border-radius: 8px;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .modal-header {
        background: #2c3e50;
        color: white;
        border-radius: 8px 8px 0 0;
    }
    
    .modal-title {
        font-weight: 600;
    }
    
    .activity-detail-item {
        margin-bottom: 20px;
    }
    
    .activity-detail-item strong {
        color: #2c3e50;
        font-size: 0.9rem;
        display: block;
        margin-bottom: 5px;
    }
    
    .activity-detail-item p {
        margin: 0;
        color: #495057;
        font-size: 1rem;
        padding: 8px 12px;
        background: #f8f9fa;
        border-radius: 4px;
        border-left: 3px solid #2c3e50;
    }
    
    .pagination-container {
        background: white;
        border-radius: 8px;
        margin-top: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e9ecef;
    }
    
    .pagination .page-link {
        color: #2c3e50;
        border-color: #e9ecef;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #2c3e50;
        border-color: #2c3e50;
        color: white;
    }
    
    .pagination .page-link:hover {
        background-color: #f8f9fa;
        color: #2c3e50;
    }
    
    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        background-color: transparent;
    }
    
    @media (max-width: 600px) {
        .main-container {
            padding: 15px;
        }
        
        .page-header {
            padding: 20px;
        }
        
        .selector-section,
        .activities-section {
            padding: 20px;
        }
        
        .activities-list {
            padding: 15px 20px;
        }
        
        .activity-item {
            padding: 15px;
        }
        
        .pagination {
            font-size: 0.9rem;
        }
        
        .pagination .page-link {
            padding: 0.375rem 0.5rem;
        }
    }
</style>

<div class="main-container">
    <div class="page-header">
        <h4>Visualização de Atividades</h4>
    </div>
    
    <div class="selector-section">
        <form method="get">
            <div class="mb-3">
                <label for="responsavel" class="form-label">Selecione o Responsável</label>
                <select id="responsavel" name="responsavel" class="form-select" onchange="this.form.submit()">
                    <option value="">-- Selecione um responsável --</option>
                    {% for responsavel in responsaveis %}
                        <option value="{{ responsavel.id }}" {% if responsavel_selecionado and responsavel_selecionado.id == responsavel.id %}selected{% endif %}>
                            {{ responsavel.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </form>
    </div>

    {% if responsavel_selecionado and atividades %}
        <div class="activities-section">
            <div class="section-header">
                <h5>Atividades de {{ responsavel_selecionado.name }}</h5>
            </div>
            <div class="activities-list">
                {% for atividade in atividades %}
                <div class="activity-item" 
                     data-activity-id="{{ atividade.id }}"
                     data-activity-title="{{ atividade.title }}"
                     data-activity-description="{{ atividade.description }}"
                     data-activity-property="{{ atividade.property.name if atividade.property else '—' }}"
                     data-activity-created="{{ atividade.created_at.strftime('%d/%m/%Y') if atividade.created_at else '—' }}"
                     data-activity-deadline="{{ atividade.delivery_date.strftime('%d/%m/%Y') if atividade.delivery_date else '—' }}"
                     data-activity-status="{{ translate_status(atividade.status) }}"
                     data-activity-status-class="{{ get_status_class(atividade.status) }}"
                     data-activity-status-code="{{ atividade.status }}"
                     onclick="showActivityDetailsFromData(this)">
                    <div class="activity-header">
                        <div class="activity-title">
                            {{ atividade.title.upper() }}
                        </div>
                        <div class="activity-status-container">
                            <span class="badge status-badge {{ get_status_class(atividade.status) }}">
                                {{ translate_status(atividade.status).upper() }}
                            </span>
                            <i class="fas fa-eye view-icon"></i>
                        </div>
                    </div>
                    <div class="activity-footer">
                        <div>
                            <strong>Condomínio:</strong> {{ atividade.property.name if atividade.property else '—' }}
                        </div>
                        <div>
                            {% if atividade.delivery_date %}
                                <strong>Prazo:</strong> {{ atividade.delivery_date.strftime('%d/%m/%Y') }}
                            {% else %}
                                <strong>Prazo:</strong> Sem prazo
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Paginação -->
            {% if pagination and pagination.pages > 1 %}
            <div class="pagination-container" style="text-align: center; padding: 20px 0;">
                <nav aria-label="Navegação de páginas">
                    <ul class="pagination justify-content-center">
                        <!-- Botão Anterior -->
                        {% if pagination.has_prev %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.public_view', responsavel=responsavel_selecionado.id, page=pagination.prev_num) }}">
                                <i class="fas fa-chevron-left"></i> Anterior
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-chevron-left"></i> Anterior</span>
                        </li>
                        {% endif %}
                        
                        <!-- Números das páginas -->
                        {% for page_num in range(1, pagination.pages + 1) %}
                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('main.public_view', responsavel=responsavel_selecionado.id, page=page_num) }}">
                                {{ page_num }}
                            </a>
                        </li>
                        {% endfor %}
                        
                        <!-- Botão Próximo -->
                        {% if pagination.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('main.public_view', responsavel=responsavel_selecionado.id, page=pagination.next_num) }}">
                                Próximo <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Próximo <i class="fas fa-chevron-right"></i></span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                
                <!-- Informações da paginação -->
                <div class="pagination-info" style="margin-top: 10px; color: #6c757d; font-size: 0.9rem;">
                    Mostrando {{ (pagination.page - 1) * pagination.per_page + 1 }} a {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} 
                    de {{ pagination.total }} atividades
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Modal para detalhes da atividade -->
        <div class="modal fade" id="activityModal" tabindex="-1" aria-labelledby="activityModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="activityModalLabel">Detalhes da Atividade</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="activity-detail-item">
                            <strong>Título</strong>
                            <p id="modal-title"></p>
                        </div>
                        <div class="activity-detail-item">
                            <strong>Data de Criação</strong>
                            <p id="modal-created"></p>
                        </div>
                        <div class="activity-detail-item">
                            <strong>Condomínio</strong>
                            <p id="modal-property"></p>
                        </div>
                        <div class="activity-detail-item">
                            <strong>Descrição</strong>
                            <p id="modal-description"></p>
                        </div>
                        <div class="activity-detail-item">
                            <strong>Prazo de Entrega</strong>
                            <p id="modal-deadline"></p>
                        </div>
                        <div class="activity-detail-item">
                            <strong>Status</strong>
                            <p><span id="modal-status" class="badge"></span></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        <button type="button" class="btn btn-primary" id="enviar-verificacao-btn" onclick="confirmarEnviarVerificacao()" style="display: none;">
                            <i class="fas fa-check"></i> Enviar para Verificação
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de confirmação -->
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmModalLabel">Confirmar Envio</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <p>Tem certeza que deseja enviar esta atividade para verificação?</p>
                        <p class="text-muted mb-0"><strong>Atividade:</strong> <span id="confirm-activity-title"></span></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="enviarParaVerificacao()">
                            <i class="fas fa-check"></i> Confirmar Envio
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            function showActivityDetailsFromData(element) {
                // Obter dados dos data attributes
                const id = element.getAttribute('data-activity-id');
                const title = element.getAttribute('data-activity-title');
                const description = element.getAttribute('data-activity-description');
                const property = element.getAttribute('data-activity-property');
                const created = element.getAttribute('data-activity-created');
                const deadline = element.getAttribute('data-activity-deadline');
                const status = element.getAttribute('data-activity-status');
                const statusClass = element.getAttribute('data-activity-status-class');
                const statusCode = element.getAttribute('data-activity-status-code');
                
                // Preencher os dados do modal
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-description').textContent = description;
                document.getElementById('modal-property').textContent = property;
                document.getElementById('modal-created').textContent = created;
                document.getElementById('modal-deadline').textContent = deadline;
                
                // Configurar o status com a classe correta
                const statusElement = document.getElementById('modal-status');
                statusElement.textContent = status.toUpperCase();
                statusElement.className = `badge ${statusClass}`;
                
                // Armazenar o ID da atividade para usar no botão de enviar para verificação
                document.getElementById('activityModal').setAttribute('data-activity-id', id);
                document.getElementById('activityModal').setAttribute('data-activity-status', statusCode);
                
                // Mostrar/esconder botão de enviar para verificação baseado no status
                const enviarBtn = document.getElementById('enviar-verificacao-btn');
                if (statusCode === 'in_progress' || statusCode === 'overdue') {
                    enviarBtn.style.display = 'inline-block';
                } else {
                    enviarBtn.style.display = 'none';
                }
                
                // Mostrar o modal
                const modal = new bootstrap.Modal(document.getElementById('activityModal'));
                modal.show();
            }
            
            function confirmarEnviarVerificacao() {
                // Obter o título da atividade do modal principal
                const activityTitle = document.getElementById('modal-title').textContent;
                document.getElementById('confirm-activity-title').textContent = activityTitle;
                
                // Fechar o modal de detalhes
                bootstrap.Modal.getInstance(document.getElementById('activityModal')).hide();
                
                // Mostrar o modal de confirmação
                const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
                confirmModal.show();
            }
            
            function enviarParaVerificacao() {
                const activityId = document.getElementById('activityModal').getAttribute('data-activity-id');
                if (activityId) {
                    // Enviar requisição para enviar para verificação
                    fetch(`/atividade/${activityId}/enviar-verificacao`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Fechar o modal de confirmação
                            bootstrap.Modal.getInstance(document.getElementById('confirmModal')).hide();
                            alert('Atividade enviada para verificação com sucesso!');
                            // Recarregar a página para atualizar a lista
                            location.reload();
                        } else {
                            alert('Erro ao enviar para verificação: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        alert('Erro ao enviar para verificação. Tente novamente.');
                    });
                }
            }
            
            // Adicionar indicador visual de que o card é clicável
            document.addEventListener('DOMContentLoaded', function() {
                const activityItems = document.querySelectorAll('.activity-item');
                activityItems.forEach(item => {
                    item.style.cursor = 'pointer';
                    item.title = 'Clique para ver detalhes';
                });
            });
        </script>
    {% elif responsavel_selecionado and not atividades %}
        <div class="activities-section">
            <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>Nenhuma atividade ativa encontrada para {{ responsavel_selecionado.name }}.</p>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %} 