{% extends "base.html" %}
{% block title %}Approvals{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="card shadow mb-4">
        <div class="card-header py-3 rounded-top text-center">
            <h6 class="m-0 font-weight-bold text-white" style="text-transform: uppercase;">APPROVALS PENDING</h6>
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-bordered text-center align-middle table-atividades" width="100%" cellspacing="0">
            <thead>
                <tr>
                    <th>Condominium</th>
                    <th>Launch</th>
                    <th>Responsible</th>
                    <th>Activity</th>
                    <th>Deliver by</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if activities %}
                    {% for activity in activities %}
                    <tr>
                        <td>{{ activity.property.nome if activity.property else '—' }}</td>
                        <td>{% if activity.data_lancamento %}{{ activity.data_lancamento.strftime('%d/%m/%y') }}{% else %}—{% endif %}</td>
                        <td>{{ activity.responsavel.username if activity.responsavel else '—' }}</td>
                        <td>{{ activity.atividade }}</td>
                        <td>{% if activity.delivery_date %}{{ activity.delivery_date.strftime('%d/%m/%y') }}{% else %}—{% endif %}</td>
                        <td><span class="badge badge-status-{{ activity.status.replace(' ', '-').lower() }}">{{ activity.status.upper() }}</span></td>
                        <td>
                            <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#modalVisualizar{{ activity.id }}" title="Visualize"><i class="fas fa-eye"></i></button>
                            <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#modalAprovar{{ activity.id }}" title="Approve"><i class="fas fa-check"></i></button>
                            <button type="button" class="btn btn-warning btn-sm" style="background-color: #ffc107 !important; border-color: #ffc107 !important; color: #212529 !important;" data-bs-toggle="modal" data-bs-target="#modalCorrecao{{ activity.id }}" title="Request Correction"><i class="fas fa-exclamation-circle"></i></button>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#modalRecusar{{ activity.id }}" title="Reject"><i class="fas fa-times"></i></button>
                        </td>
                    </tr>
                    <!-- Modal Visualizar Atividade -->
                    <div class="modal fade" id="modalVisualizar{{ activity.id }}" tabindex="-1" aria-labelledby="modalVisualizarLabel{{ activity.id }}" aria-hidden="true">
                      <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content shadow-lg rounded-4 border-0">
                          <div class="modal-header" style="background: #11141b; color: #fff; border-top-left-radius: 1rem; border-top-right-radius: 1rem;">
                            <h5 class="modal-title fw-bold" id="modalVisualizarLabel{{ activity.id }}">
                              <i class="fas fa-tasks me-2"></i>Activity Details
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body p-4">
                            <div class="row g-3">
                              <div class="col-12">
                                <div class="mb-2"><i class="fas fa-building me-1 text-secondary"></i> <strong>Property:</strong></div>
                                <div>{{ activity.property.nome if activity.property else '—' }}</div>
                              </div>
                              <div class="col-12 col-md-6">
                                <div class="mb-2"><i class="fas fa-tasks me-1 text-secondary"></i> <strong>Activity:</strong></div>
                                <div>{{ activity.atividade }}</div>
                              </div>
                              <div class="col-12 col-md-6">
                                <div class="mb-2"><i class="fas fa-calendar-plus me-1 text-secondary"></i> <strong>Launch:</strong></div>
                                <div>{% if activity.data_lancamento %}{{ activity.data_lancamento.strftime('%d/%m/%y') }}{% else %}—{% endif %}</div>
                              </div>
                              <div class="col-12 col-md-6">
                                <div class="mb-2"><i class="fas fa-user me-1 text-secondary"></i> <strong>Responsible:</strong></div>
                                <div>{{ activity.responsavel.username if activity.responsavel else '—' }}</div>
                              </div>
                              <div class="col-12 col-md-6">
                                <div class="mb-2"><i class="fas fa-calendar-alt me-1 text-secondary"></i> <strong>Deliver by:</strong></div>
                                <div>{% if activity.delivery_date %}{{ activity.delivery_date.strftime('%d/%m/%y') }}{% else %}—{% endif %}</div>
                              </div>
                              <div class="col-12">
                                <div class="mb-2"><i class="fas fa-align-left me-1 text-secondary"></i> <strong>Description:</strong></div>
                                <div>{{ activity.description }}</div>
                              </div>
                              <div class="col-12 col-md-6">
                                <div class="mb-2"><i class="fas fa-flag me-1 text-secondary"></i> <strong>Status:</strong></div>
                                <div><span class="badge badge-status-{{ activity.status.replace(' ', '-').lower() }}" style="font-size:1.1em;">{{ activity.status.upper() }}</span></div>
                              </div>
                              {% if activity.cancellation_reason %}
                              <div class="col-12">
                                <div class="alert alert-warning mt-2 mb-0 fw-semibold" style="font-size:1.05em;">
                                  <i class="fas fa-exclamation-triangle me-1"></i>
                                  Cancelation Reason: {{ activity.cancellation_reason }}
                                </div>
                              </div>
                              {% endif %}
                              {% if activity.correction_reason %}
                              <div class="col-12">
                                <div class="alert alert-warning mt-2 mb-0 fw-semibold" style="font-size:1.05em;">
                                  <i class="fas fa-exclamation-circle me-1"></i>
                                  <strong>Correction Requested:</strong> {{ activity.correction_reason }}
                                </div>
                              </div>
                              {% endif %}
                              {% if activity.approved_by %}
                              <div class="col-12 col-md-6">
                                <div class="mb-2"><i class="fas fa-user-check me-1 text-secondary"></i> <strong>Approved by:</strong></div>
                                <div>{{ activity.approved_by.username }}</div>
                              </div>
                              {% endif %}
                            </div>
                          </div>
                          <div class="modal-footer bg-light rounded-bottom-4">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Modal Aprovar -->
                    <div class="modal fade" id="modalAprovar{{ activity.id }}" tabindex="-1" aria-labelledby="modalAprovarLabel{{ activity.id }}" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="modalAprovarLabel{{ activity.id }}">Confirm Approval</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            Are you sure you want to <strong class="text-success">approve</strong> this activity?
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <form method="POST" action="{{ url_for('main.approve_activity', activity_id=activity.id) }}" style="display:inline;">
                              <button type="submit" class="btn btn-success">Approve</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- Modal Solicitar Correção -->
                    <div class="modal fade" id="modalCorrecao{{ activity.id }}" tabindex="-1" aria-labelledby="modalCorrecaoLabel{{ activity.id }}" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="modalCorrecaoLabel{{ activity.id }}">Request Correction</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <form method="POST" action="{{ url_for('main.request_correction_activity', activity_id=activity.id) }}">
                            <div class="modal-body">
                              <div class="mb-3">
                                <label for="motivo_correcao_{{ activity.id }}" class="form-label fw-semibold">Correction Reason <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="motivo_correcao_{{ activity.id }}" name="motivo_correcao" rows="3" required placeholder="Describe the reason..."></textarea>
                              </div>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                              <button type="submit" class="btn btn-warning">Request Correction</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div>
                    <!-- Modal Recusar -->
                    <div class="modal fade" id="modalRecusar{{ activity.id }}" tabindex="-1" aria-labelledby="modalRecusarLabel{{ activity.id }}" aria-hidden="true">
                      <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title" id="modalRecusarLabel{{ activity.id }}">Confirm Rejection</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            Are you sure you want to <strong class="text-danger">reject</strong> this activity?
                          </div>
                          <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <form method="POST" action="{{ url_for('main.reject_activity', activity_id=activity.id) }}" style="display:inline;">
                              <button type="submit" class="btn btn-danger">Reject</button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="text-center">No activities awaiting approval.</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %} 